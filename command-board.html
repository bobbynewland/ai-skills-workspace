<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Mission Control">
    <title>ğŸš€ Mission Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: { 50: '#f9fafb', 100: '#f3f 200: '#e5e7eb', 3004f6',: '#d1d5db', 400: '#9ca3af', 500: '#6b7280', 600: '#4b5563', 700: '#374151', 800: '#1f2937', 900: '#111827', 950: '#0a0a0f' },
                        primary: { 400: '#a78bfa', 500: '#8b5cf6', 600: '#7c3aed', 700: '#6d28d9' }
                    }
                }
            }
        }
    </script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; overscroll-behavior-y: none; }
        .app-scroll { height: 100%; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .board-scroll { 
            display: flex; gap: 0.75rem; 
            overflow-x: auto; overflow-y: hidden; 
            -webkit-overflow-scrolling: touch; 
            padding: 0 1rem 6rem;
            scroll-snap-type: x mandatory;
        }
        .board-scroll > * { scroll-snap-align: start; }
        
        .cards-scroll {
            max-height: calc(100vh - 14rem);
            overflow-y: auto; -webkit-overflow-scrolling: touch;
        }
        
        .dragging { opacity: 0.9; transform: scale(1.02); box-shadow: 0 25px 50px rgba(139, 92, 246, 0.3); z-index: 50; }
        .drag-over { border: 2px solid #a78bfa; background: rgba(167, 139, 250, 0.1); }
        .fab:active { transform: scale(0.95); }
        .nav-item.active { color: #a78bfa; }
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s ease; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 1rem); }
    </style>
</head>
<body class="bg-dark-950 text-gray-200 font-sans">
    <div id="app" class="app-scroll">
        <header class="sticky top-0 z-40 bg-dark-950/80 backdrop-blur-lg border-b border-dark-800/50 px-5 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-xl font-bold bg-gradient-to-r from-white to-primary-400 bg-clip-text text-transparent">ğŸš€ Mission Control</h1>
                    <p class="text-xs text-gray-500 mt-0.5">Your command center</p>
                </div>
                <div id="statusIndicator" class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-dark-800/50">
                    <span id="statusDot" class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span>
                    <span id="statusText" class="text-xs text-gray-400">Loading...</span>
                </div>
            </div>
        </header>

        <div class="sticky top-24 z-30 bg-dark-950/95 backdrop-blur-sm px-5 py-3 border-b border-dark-800/30">
            <div class="flex gap-2 overflow-x-auto no-scrollbar pb-1">
                <button onclick="switchTab('tasks')" class="tab-btn active px-4 py-2 rounded-xl text-sm font-medium bg-primary-500/15 text-primary-400 border border-primary-500/30 whitespace-nowrap transition-all" data-tab="tasks">ğŸ“‹ Tasks</button>
                <button onclick="switchTab('notes')" class="tab-btn px-4 py-2 rounded-xl text-sm font-medium bg-dark-800/50 text-gray-400 border border-dark-700/50 whitespace-nowrap transition-all" data-tab="notes">ğŸ“ Notes</button>
                <button onclick="switchTab('files')" class="tab-btn px-4 py-2 rounded-xl text-sm font-medium bg-dark-800/50 text-gray-400 border border-dark-700/50 whitespace-nowrap transition-all" data-tab="files">ğŸ“ Files</button>
                <button onclick="switchTab('tools')" class="tab-btn px-4 py-2 rounded-xl text-sm font-medium bg-dark-800/50 text-gray-400 border border-dark-700/50 whitespace-nowrap transition-all" data-tab="tools">ğŸ”§ Tools</button>
            </div>
        </div>

        <div id="stats-bar" class="px-5 py-3 flex gap-2 overflow-x-auto no-scrollbar">
            <div class="stat-pill px-4 py-2 rounded-full bg-dark-800/40 border border-dark-700/50 text-xs whitespace-nowrap">Total: <span id="stat-total" class="text-primary-400 font-semibold">0</span></div>
            <div class="stat-pill px-4 py-2 rounded-full bg-dark-800/40 border border-dark-700/50 text-xs whitespace-nowrap">To Do: <span id="stat-todo" class="text-red-400 font-semibold">0</span></div>
            <div class="stat-pill px-4 py-2 rounded-full bg-dark-800/40 border border-dark-700/50 text-xs whitespace-nowrap">Progress: <span id="stat-progress" class="text-amber-400 font-semibold">0</span></div>
            <div class="stat-pill px-4 py-2 rounded-full bg-dark-800/40 border border-dark-700/50 text-xs whitespace-nowrap">Done: <span id="stat-done" class="text-blue-400 font-semibold">0</span></div>
        </div>

        <div id="tasks-tab" class="tab-content block">
            <div id="board" class="board-scroll">
                <div class="column min-w-[17.5rem] max-w-[17.5rem] flex-shrink-0 flex flex-col">
                    <div class="flex items-center justify-between mb-4 pb-3 border-b-2 border-red-400/50 px-1">
                        <div class="flex items-center gap-2"><span class="text-lg">ğŸ“‹</span><span class="font-semibold text-sm">To Do</span><span id="count-todo" class="px-2 py-0.5 rounded-full bg-dark-700/50 text-xs">0</span></div>
                    </div>
                    <div id="col-todo" class="cards-scroll flex-1" data-status="todo"></div>
                </div>
                <div class="column min-w-[17.5rem] max-w-[17.5rem] flex-shrink-0 flex flex-col">
                    <div class="flex items-center justify-between mb-4 pb-3 border-b-2 border-amber-400/50 px-1">
                        <div class="flex items-center gap-2"><span class="text-lg">ğŸ”¥</span><span class="font-semibold text-sm">In Progress</span><span id="count-progress" class="px-2 py-0.5 rounded-full bg-dark-700/50 text-xs">0</span></div>
                    </div>
                    <div id="col-progress" class="cards-scroll flex-1" data-status="progress"></div>
                </div>
                <div class="column min-w-[17.5rem] max-w-[17.5rem] flex-shrink-0 flex flex-col">
                    <div class="flex items-center justify-between mb-4 pb-3 border-b-2 border-emerald-400/50 px-1">
                        <div class="flex items-center gap-2"><span class="text-lg">ğŸ‘€</span><span class="font-semibold text-sm">Review</span><span id="count-review" class="px-2 py-0.5 rounded-full bg-dark-700/50 text-xs">0</span></div>
                    </div>
                    <div id="col-review" class="cards-scroll flex-1" data-status="review"></div>
                </div>
                <div class="column min-w-[17.5rem] max-w-[17.5rem] flex-shrink-0 flex flex-col">
                    <div class="flex items-center justify-between mb-4 pb-3 border-b-2 border-blue-400/50 px-1">
                        <div class="flex items-center gap-2"><span class="text-lg">âœ…</span><span class="font-semibold text-sm">Done</span><span id="count-done" class="px-2 py-0.5 rounded-full bg-dark-700/50 text-xs">0</span></div>
                    </div>
                    <div id="col-done" class="cards-scroll flex-1" data-status="done"></div>
                </div>
            </div>
        </div>

        <div id="notes-tab" class="tab-content hidden px-5 pb-24">
            <div id="notes-list" class="space-y-3">
                <!-- Notes loaded from Firebase -->
            </div>
            <button onclick="openNoteModal()" class="mt-4 w-full py-4 rounded-xl bg-dark-800/40 border border-dark-700/50 text-gray-400 text-sm font-medium active:bg-dark-800/60 transition">
                + New Note
            </button>
        </div>

        <div id="files-tab" class="tab-content hidden px-5 pb-24">
            <div class="grid grid-cols-2 gap-3">
                <div onclick="alert('Coming soon!')" class="bg-dark-800/40 border border-dark-700/50 rounded-xl p-4 text-center cursor-pointer active:bg-dark-800/60 transition"><div class="text-3xl mb-2">ğŸ“</div><div class="text-xs font-medium">Template Pack V4</div></div>
                <div onclick="alert('Coming soon!')" class="bg-dark-800/40 border border-dark-700/50 rounded-xl p-4 text-center cursor-pointer active:bg-dark-800/60 transition"><div class="text-3xl mb-2">ğŸ¨</div><div class="text-xs font-medium">Brand Assets</div></div>
            </div>
        </div>

        <div id="tools-tab" class="tab-content hidden px-5 pb-24">
            <div class="grid grid-cols-2 gap-3">
                <div onclick="openTool('docs')" class="bg-dark-800/40 border border-dark-700/50 rounded-2xl p-5 text-center cursor-pointer active:bg-dark-800/60 transition"><div class="text-3xl mb-2">ğŸ“„</div><div class="text-sm font-semibold">Docs</div></div>
                <div onclick="openTool('sheets')" class="bg-dark-800/40 border border-dark-700/50 rounded-2xl p-5 text-center cursor-pointer active:bg-dark-800/60 transition"><div class="text-3xl mb-2">ğŸ“Š</div><div class="text-sm font-semibold">Sheets</div></div>
                <div onclick="openTool('drive')" class="bg-dark-800/40 border border-dark-700/50 rounded-2xl p-5 text-center cursor-pointer active:bg-dark-800/60 transition"><div class="text-3xl mb-2">â˜ï¸</div><div class="text-sm font-semibold">Drive</div></div>
                <div onclick="openTool('calendar')" class="bg-dark-800/40 border border-dark-700/50 rounded-2xl p-5 text-center cursor-pointer active:bg-dark-800/60 transition"><div class="text-3xl mb-2">ğŸ“…</div><div class="text-sm font-semibold">Calendar</div></div>
                <div onclick="openTool('gmail')" class="bg-dark-800/40 border border-dark-700/50 rounded-2xl p-5 text-center cursor-pointer active:bg-dark-800/60 transition"><div class="text-3xl mb-2">âœ‰ï¸</div><div class="text-sm font-semibold">Gmail</div></div>
                <div onclick="openTool('photos')" class="bg-dark-800/40 border border-dark-700/50 rounded-2xl p-5 text-center cursor-pointer active:bg-dark-800/60 transition"><div class="text-3xl mb-2">ğŸ–¼ï¸</div><div class="text-sm font-semibold">Photos</div></div>
            </div>
        </div>
    </div>

    <button id="taskFab" onclick="openAddModal()" class="fab fixed bottom-6 right-6 w-14 h-14 rounded-2xl bg-gradient-to-br from-primary-400 to-primary-600 text-white text-2xl shadow-lg shadow-primary-500/30 z-50 flex items-center justify-center active:scale-95 transition-transform">+</button>

    <nav class="fixed bottom-0 left-0 right-0 bg-dark-900/95 backdrop-blur-lg border-t border-dark-800/50 z-40 pb-safe">
        <div class="flex justify-around py-2 px-2">
            <button onclick="switchTab('tasks')" class="nav-item flex-1 py-3 px-4 text-center text-gray-400 active:text-primary-400 transition-colors"><div class="text-xl mb-0.5">ğŸ“‹</div><div class="text-xs font-medium">Tasks</div></button>
            <button onclick="switchTab('notes')" class="nav-item flex-1 py-3 px-4 text-center text-gray-400 active:text-primary-400 transition-colors"><div class="text-xl mb-0.5">ğŸ“</div><div class="text-xs font-medium">Notes</div></button>
            <button onclick="switchTab('files')" class="nav-item flex-1 py-3 px-4 text-center text-gray-400 active:text-primary-400 transition-colors"><div class="text-xl mb-0.5">ğŸ“</div><div class="text-xs font-medium">Files</div></button>
            <button onclick="switchTab('tools')" class="nav-item flex-1 py-3 px-4 text-center text-gray-400 active:text-primary-400 transition-colors"><div class="text-xl mb-0.5">ğŸ”§</div><div class="text-xs font-medium">Tools</div></button>
        </div>
    </nav>

    <div id="addModal" class="modal fixed inset-0 bg-black/80 z-[100] hidden items-end justify-center sm:items-center">
        <div class="bg-dark-800 w-full max-w-lg rounded-t-3xl sm:rounded-3xl p-6 animate-slide-up max-h-[85vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6"><h2 class="text-xl font-bold">New Task</h2><button onclick="closeModal('addModal')" class="w-10 h-10 rounded-xl bg-dark-700/50 text-gray-400 text-xl">Ã—</button></div>
            <form onsubmit="submitNewTask(event)">
                <div class="space-y-4">
                    <div><label class="block text-xs text-gray-500 mb-2">Title</label><input type="text" id="addTitle" required class="w-full px-4 py-3 rounded-xl bg-dark-700/50 border border-dark-600 text-white text-base focus:outline-none focus:border-primary-500" placeholder="Task title..."></div>
                    <div><label class="block text-xs text-gray-500 mb-2">Description</label><textarea id="addDesc" rows="3" class="w-full px-4 py-3 rounded-xl bg-dark-700/50 border border-dark-600 text-white text-base focus:outline-none focus:border-primary-500 resize-none" placeholder="Add details..."></textarea></div>
                    <div><label class="block text-xs text-gray-500 mb-2">Category</label><select id="addCategory" class="w-full px-4 py-3 rounded-xl bg-dark-700/50 border border-dark-600 text-white text-base focus:outline-none focus:border-primary-500"><option value="dev">ğŸ’» Dev</option><option value="marketing">ğŸ“£ Marketing</option><option value="content">ğŸ¨ Content</option><option value="ambassador">ğŸ¤ Ambassador</option><option value="ops">âš™ï¸ Ops</option><option value="michigan">ğŸ”ï¸ Michigan Project</option><option value="internal">ğŸ  Internal</option></select></div>
                    <div><label class="block text-xs text-gray-500 mb-2">Priority</label><select id="addPriority" class="w-full px-4 py-3 rounded-xl bg-dark-700/50 border border-dark-600 text-white text-base focus:outline-none focus:border-primary-500"><option value="high">ğŸ”´ High</option><option value="medium">ğŸŸ¡ Medium</option><option value="low">ğŸŸ¢ Low</option></select></div>
                </div>
                <div class="flex gap-3 mt-6"><button type="button" onclick="closeModal('addModal')" class="flex-1 py-3.5 rounded-xl bg-dark-700/50 text-gray-300 font-semibold">Cancel</button><button type="submit" class="flex-1 py-3.5 rounded-xl bg-gradient-to-r from-primary-500 to-primary-600 text-white font-semibold">Create</button></div>
            </form>
        </div>
    </div>

    <div id="editModal" class="modal fixed inset-0 bg-black/80 z-[100] hidden items-end justify-center sm:items-center">
        <div class="bg-dark-800 w-full max-w-lg rounded-t-3xl sm:rounded-3xl p-6 animate-slide-up max-h-[85vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6"><h2 class="text-xl font-bold">Task Details</h2><button onclick="closeModal('editModal')" class="w-10 h-10 rounded-xl bg-dark-700/50 text-gray-400 text-xl">Ã—</button></div>
            <form onsubmit="saveTask(event)">
                <input type="hidden" id="editId">
                <div class="space-y-4">
                    <div><label class="block text-xs text-gray-500 mb-2">Status</label><select id="editStatus" class="w-full px-4 py-3 rounded-xl bg-dark-700/50 border border-dark-600 text-white text-base focus:outline-none focus:border-primary-500"><option value="todo">ğŸ“‹ To Do</option><option value="progress">ğŸ”¥ In Progress</option><option value="review">ğŸ‘€ Review</option><option value="done">âœ… Done</option></select></div>
                    <div><label class="block text-xs text-gray-500 mb-2">Title</label><input type="text" id="editTitle" required class="w-full px-4 py-3 rounded-xl bg-dark-700/50 border border-dark-600 text-white text-base focus:outline-none focus:border-primary-500"></div>
                    <div><label class="block text-xs text-gray-500 mb-2">Description</label><textarea id="editDesc" rows="3" class="w-full px-4 py-3 rounded-xl bg-dark-700/50 border border-dark-600 text-white text-base focus:outline-none focus:border-primary-500 resize-none"></textarea></div>
                    <div><label class="block text-xs text-gray-500 mb-2">Category</label><select id="editCategory" class="w-full px-4 py-3 rounded-xl bg-dark-700/50 border border-dark-600 text-white text-base focus:outline-none focus:border-primary-500"><option value="dev">ğŸ’» Dev</option><option value="marketing">ğŸ“£ Marketing</option><option value="content">ğŸ¨ Content</option><option value="ambassador">ğŸ¤ Ambassador</option><option value="ops">âš™ï¸ Ops</option><option value="michigan">ğŸ”ï¸ Michigan Project</option><option value="internal">ğŸ  Internal</option></select></div>
                    <div><label class="block text-xs text-gray-500 mb-2">Priority</label><select id="editPriority" class="w-full px-4 py-3 rounded-xl bg-dark-700/50 border border-dark-600 text-white text-base focus:outline-none focus:border-primary-500"><option value="high">ğŸ”´ High</option><option value="medium">ğŸŸ¡ Medium</option><option value="low">ğŸŸ¢ Low</option></select></div>
                </div>
                <div class="flex gap-3 mt-6"><button type="button" onclick="deleteTask()" class="flex-1 py-3.5 rounded-xl bg-red-500/15 text-red-400 font-semibold">Delete</button><button type="submit" class="flex-1 py-3.5 rounded-xl bg-gradient-to-r from-primary-500 to-primary-600 text-white font-semibold">Save</button></div>
            </form>
        </div>
    </div>

    <!-- Note Modal -->
    <div id="noteModal" class="modal fixed inset-0 bg-black/80 z-[100] hidden items-end justify-center sm:items-center">
        <div class="bg-dark-800 w-full max-w-lg rounded-t-3xl sm:rounded-3xl p-6 animate-slide-up max-h-[85vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-6"><h2 class="text-xl font-bold">New Note</h2><button onclick="closeModal('noteModal')" class="w-10 h-10 rounded-xl bg-dark-700/50 text-gray-400 text-xl">Ã—</button></div>
            <form onsubmit="submitNewNote(event)">
                <div class="space-y-4">
                    <div><label class="block text-xs text-gray-500 mb-2">Title</label><input type="text" id="noteTitle" required class="w-full px-4 py-3 rounded-xl bg-dark-700/50 border border-dark-600 text-white text-base focus:outline-none focus:border-primary-500" placeholder="Note title..."></div>
                    <div><label class="block text-xs text-gray-500 mb-2">Content</label><textarea id="noteContent" rows="8" class="w-full px-4 py-3 rounded-xl bg-dark-700/50 border border-dark-600 text-white text-base focus:outline-none focus:border-primary-500 resize-none" placeholder="Brain dump, ideas, meeting notes..."></textarea></div>
                    <div><label class="block text-xs text-gray-500 mb-2">Type</label><select id="noteType" class="w-full px-4 py-3 rounded-xl bg-dark-700/50 border border-dark-600 text-white text-base focus:outline-none focus:border-primary-500"><option value="brain_dump">ğŸ§  Brain Dump</option><option value="meeting">ğŸ“… Meeting Notes</option><option value="idea">ğŸ’¡ Idea</option><option value="project">ğŸ“‹ Project</option></select></div>
                </div>
                <div class="flex gap-3 mt-6"><button type="button" onclick="closeModal('noteModal')" class="flex-1 py-3.5 rounded-xl bg-dark-700/50 text-gray-300 font-semibold">Cancel</button><button type="submit" class="flex-1 py-3.5 rounded-xl bg-gradient-to-r from-primary-500 to-primary-600 text-white font-semibold">Save</button></div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = { apiKey: "AIzaSyB3Z1WDeqO4cEBMk5Q1j9H8c2-0Z1Y8X0", authDomain: "winslow-756c3.firebaseapp.com", databaseURL: "https://winslow-756c3-default-rtdb.firebaseio.com", projectId: "winslow-756c3", storageBucket: "winslow-756c3.appspot.com", messagingSenderId: "123456789", appId: "1:123456789:web:abc123" };

        let db = null, tasks = {}, notes = {}, isFirebaseReady = false, draggedTaskId = null, touchCard = null, touchOffset = { x: 0, y: 0 };

        function setStatus(status, text) {
            const el = document.getElementById('statusIndicator'), dot = el.querySelector('#statusDot'), txt = el.querySelector('#statusText');
            el.className = 'flex items-center gap-2 px-3 py-1.5 rounded-full ' + (status === 'saving' ? 'bg-amber-500/20' : 'bg-dark-800/50');
            dot.className = 'w-1.5 h-1.5 rounded-full ' + (status === 'saving' ? 'bg-amber-400 animate-pulse' : 'bg-emerald-400');
            txt.textContent = text;
            txt.className = 'text-xs ' + (status === 'saving' ? 'text-amber-400' : 'text-gray-400');
        }

        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            setStatus('saved', 'Firebase connected âœ“');
            isFirebaseReady = true;
        } catch(e) { setStatus('saved', 'Local mode'); isFirebaseReady = false; }

        window.loadTasks = function() {
            if (isFirebaseReady && db) {
                onValue(ref(db, 'workspaces/winslow_main/tasks'), (snap) => {
                    if (snap.val()) { tasks = snap.val(); saveToLocal(); renderBoard(); setStatus('saved', 'Synced âœ“'); }
                    else loadFromLocal();
                }, () => loadFromLocal());
            } else loadFromLocal();
        };

        window.loadNotes = function() {
            if (isFirebaseReady && db) {
                onValue(ref(db, 'workspaces/winslow_main/notes'), (snap) => {
                    if (snap.val()) { notes = snap.val(); renderNotes(); }
                    else renderNotes();
                }, () => renderNotes());
            } else renderNotes();
        };

        function saveToLocal() { localStorage.setItem('mission_tasks_backup', JSON.stringify(tasks)); }

        function loadFromLocal() {
            const saved = localStorage.getItem('mission_tasks_backup');
            if (saved) tasks = JSON.parse(saved);
            else {
                tasks = {
                    '1': { id: '1', title: "Welcome to Mission Control", desc: "Swipe to see all columns!", category: "ops", priority: "medium", status: "todo", order: 0 },
                    '2': { id: '2', title: "Try drag & drop", desc: "Touch and hold cards to move them", category: "dev", priority: "low", status: "todo", order: 1 },
                    '3': { id: '3', title: "Michigan Project Task", desc: "Example Michigan project task", category: "michigan", priority: "high", status: "progress", order: 0 },
                    '4': { id: '4', title: "Internal Project Task", desc: "Example internal project task", category: "internal", priority: "medium", status: "todo", order: 2 }
                };
            }
            renderBoard();
            setStatus('saved', 'Ready');
        }

        async function saveTasks() {
            saveToLocal();
            if (isFirebaseReady && db) {
                try {
                    setStatus('saving', 'Saving...');
                    await set(ref(db, 'workspaces/winslow_main/tasks'), tasks);
                    setStatus('saved', 'Saved âœ“');
                } catch(e) { setStatus('saved', 'Local only'); }
            }
        }

        async function saveNotes() {
            if (isFirebaseReady && db) {
                try {
                    await set(ref(db, 'workspaces/winslow_main/notes'), notes);
                } catch(e) { console.log('Notes save failed', e); }
            }
        }

        window.renderNotes = function() {
            const container = document.getElementById('notes-list');
            container.innerHTML = '';
            const noteTypes = { brain_dump: 'ğŸ§ ', meeting: 'ğŸ“…', idea: 'ğŸ’¡', project: 'ğŸ“‹' };
            const noteColors = { brain_dump: 'amber', meeting: 'blue', idea: 'emerald', project: 'primary' };
            
            Object.values(notes).sort((a,b) => b.updated - a.updated).forEach(note => {
                const div = document.createElement('div');
                div.className = 'bg-dark-800/40 border border-dark-700/50 rounded-xl p-4 cursor-pointer active:bg-dark-800/60 transition';
                div.onclick = () => openNoteEditModal(note.id);
                div.innerHTML = `
                    <div class="flex items-center gap-2 font-semibold text-sm mb-2">
                        <span class="text-lg">${noteTypes[note.type] || 'ğŸ“'}</span>
                        ${note.title}
                        <span class="ml-auto text-xs px-2 py-0.5 rounded-lg bg-${noteColors[note.type]}-500/15 text-${noteColors[note.type]}-400">${note.type.replace('_', ' ')}</span>
                    </div>
                    <p class="text-xs text-gray-500 line-clamp-3">${note.content.substring(0, 150)}${note.content.length > 150 ? '...' : ''}</p>
                    <div class="text-xs text-gray-600 mt-2">${new Date(note.updated).toLocaleDateString()}</div>
                `;
                container.appendChild(div);
            });
            
            if (Object.keys(notes).length === 0) {
                container.innerHTML = '<div class="text-center py-8 text-gray-500 text-sm">No notes yet. Create your first note!</div>';
            }
        }

        window.openNoteModal = function() { document.getElementById('noteModal').classList.remove('hidden'); document.getElementById('noteModal').classList.add('flex'); document.getElementById('noteTitle').focus(); }
        
        window.openNoteEditModal = function(id) {
            const note = notes[id];
            if (!note) return;
            const modal = document.getElementById('noteModal');
            modal.querySelector('h2').textContent = 'Edit Note';
            modal.querySelector('form').onsubmit = (e) => saveNote(e, id);
            document.getElementById('noteTitle').value = note.title;
            document.getElementById('noteContent').value = note.content;
            document.getElementById('noteType').value = note.type;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        window.submitNewNote = async function(e) {
            e.preventDefault();
            const id = Date.now().toString();
            notes[id] = { 
                id, 
                title: document.getElementById('noteTitle').value, 
                content: document.getElementById('noteContent').value, 
                type: document.getElementById('noteType').value,
                updated: Date.now() 
            };
            await saveNotes();
            renderNotes();
            closeModal('noteModal');
            e.target.reset();
            // Reset form for next use
            modal.querySelector('h2').textContent = 'New Note';
            modal.querySelector('form').onsubmit = submitNewNote;
        }

        window.saveNote = async function(e, id) {
            e.preventDefault();
            if (!notes[id]) return;
            notes[id].title = document.getElementById('noteTitle').value;
            notes[id].content = document.getElementById('noteContent').value;
            notes[id].type = document.getElementById('noteType').value;
            notes[id].updated = Date.now();
            await saveNotes();
            renderNotes();
            closeModal('noteModal');
            // Reset form
            const modal = document.getElementById('noteModal');
            modal.querySelector('h2').textContent = 'New Note';
            modal.querySelector('form').onsubmit = submitNewNote;
        }

        window.deleteNote = async function(id) {
            if (id && confirm('Delete this note?')) { 
                delete notes[id]; 
                await saveNotes(); 
                renderNotes(); 
                closeModal('noteModal');
            }
        }

        window.renderBoard = function() {
            ['todo', 'progress', 'review', 'done'].forEach(s => {
                const sts = Object.values(tasks).filter(t => t.status === s).sort((a,b) => (a.order||0) - (b.order||0));
                sts.forEach((t,i) => { if ((t.order||0) !== i) { t.order = i; tasks[t.id].order = i; } });
            });

            ['todo', 'progress', 'review', 'done'].forEach(s => {
                const container = document.getElementById('col-' + s);
                container.innerHTML = '';
                Object.values(tasks).filter(t => t.status === s).sort((a,b) => (a.order||0) - (b.order||0)).forEach(t => container.appendChild(createCard(t)));
            });
            renderStats();
        }

        function createCard(task) {
            const div = document.createElement('div');
            const categoryColors = { dev: 'blue', marketing: 'red', content: 'amber', ambassador: 'emerald', ops: 'primary', michigan: 'orange', internal: 'cyan' };
            const priorityColors = { high: 'bg-red-500', medium: 'bg-amber-400', low: 'bg-emerald-400' };
            const categoryIcons = { dev: 'ğŸ’»', marketing: 'ğŸ“£', content: 'ğŸ¨', ambassador: 'ğŸ¤', ops: 'âš™ï¸', michigan: 'ğŸ”ï¸', internal: 'ğŸ ' };

            div.className = 'bg-dark-800/40 border border-dark-700/50 rounded-xl p-4 cursor-grab active:cursor-grabbing touch-none transition-all duration-150 flex-shrink-0';
            div.dataset.id = task.id;
            div.draggable = true;
            div.innerHTML = `
                <div class="flex items-start justify-between mb-2">
                    <div class="font-medium text-sm leading-snug">${task.title}</div>
                    <span class="priority-dot ${priorityColors[task.priority]} w-2 h-2 rounded-full flex-shrink-0 ml-2"></span>
                </div>
                <div class="flex items-center gap-2 flex-wrap">
                    <span class="px-2 py-0.5 rounded-lg text-xs font-medium bg-${categoryColors[task.category]}-500/15 text-${categoryColors[task.category]}-400">${categoryIcons[task.category]} ${task.category.charAt(0).toUpperCase() + task.category.slice(1)}</span>
                </div>
            `;

            div.ondragstart = (e) => { draggedTaskId = task.id; div.classList.add('dragging'); };
            div.ondragend = () => { div.classList.remove('dragging'); draggedTaskId = null; };
            div.onclick = () => openEditModal(task.id);

            div.ontouchstart = (e) => {
                if (e.touches.length > 1) return;
                touchCard = div;
                const rect = div.getBoundingClientRect();
                touchOffset.x = e.touches[0].clientX - rect.left;
                touchOffset.y = e.touches[0].clientY - rect.top;

                div.style.position = 'fixed';
                div.style.zIndex = '9999';
                div.style.width = rect.width + 'px';
                div.style.transform = 'scale(1.05)';
                div.style.boxShadow = '0 20px 40px rgba(0,0,0,0.5)';
                div.style.opacity = '0.9';
                div.classList.add('dragging');
                draggedTaskId = task.id;
                e.preventDefault();
            };

            div.ontouchmove = (e) => {
                if (!touchCard) return;
                e.preventDefault();
                const touch = e.touches[0];
                touchCard.style.left = (touch.clientX - touchOffset.x) + 'px';
                touchCard.style.top = (touch.clientY - touchOffset.y) + 'px';
            };

            div.ontouchend = async (e) => {
                if (!touchCard) return;
                const touch = e.changedTouches[0];
                const elem = document.elementFromPoint(touch.clientX, touch.clientY);
                const container = elem?.closest('.cards-scroll');

                touchCard.style.position = '';
                touchCard.style.zIndex = '';
                touchCard.style.left = '';
                touchCard.style.top = '';
                touchCard.style.width = '';
                touchCard.style.transform = '';
                touchCard.style.boxShadow = '';
                touchCard.style.opacity = '';
                touchCard.classList.remove('dragging');

                if (container && draggedTaskId) {
                    const newStatus = container.dataset.status;
                    tasks[draggedTaskId].status = newStatus;
                    await saveTasks();
                    renderBoard();
                }

                touchCard = null;
                draggedTaskId = null;
            };

            return div;
        }

        window.renderStats = function() {
            const counts = { total: Object.keys(tasks).length, todo: 0, progress: 0, review: 0, done: 0 };
            Object.values(tasks).forEach(t => { if (counts[t.status] !== undefined) counts[t.status]++; });
            ['todo', 'progress', 'review', 'done'].forEach(s => {
                document.getElementById('stat-' + s).textContent = counts[s];
                document.getElementById('count-' + s).textContent = counts[s];
            });
            document.getElementById('stat-total').textContent = counts.total;
        }

        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => {
                if (b.dataset.tab === tab) {
                    b.className = 'px-4 py-2 rounded-xl text-sm font-medium bg-primary-500/15 text-primary-400 border border-primary-500/30 whitespace-nowrap transition-all';
                } else {
                    b.className = 'px-4 py-2 rounded-xl text-sm font-medium bg-dark-800/50 text-gray-400 border border-dark-700/50 whitespace-nowrap transition-all';
                }
            });
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.getElementById(tab + '-tab').classList.remove('hidden');
            document.getElementById('taskFab').style.display = tab === 'tasks' ? 'flex' : 'none';
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector(`.nav-item[onclick="switchTab('${tab}')"]`)?.classList.add('active');
            
            if (tab === 'notes') loadNotes();
        }

        window.openAddModal = function() { document.getElementById('addModal').classList.remove('hidden'); document.getElementById('addModal').classList.add('flex'); document.getElementById('addTitle').focus(); }
        window.openEditModal = function(id) {
            const t = tasks[id];
            document.getElementById('editId').value = id;
            document.getElementById('editTitle').value = t.title;
            document.getElementById('editDesc').value = t.desc || '';
            document.getElementById('editStatus').value = t.status;
            document.getElementById('editCategory').value = t.category;
            document.getElementById('editPriority').value = t.priority;
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }
        window.closeModal = function(id) { 
            document.getElementById(id).classList.add('hidden'); 
            document.getElementById(id).classList.remove('flex'); 
            // Reset note modal form if closing
            if (id === 'noteModal') {
                const modal = document.getElementById('noteModal');
                modal.querySelector('h2').textContent = 'New Note';
                modal.querySelector('form').onsubmit = submitNewNote;
                modal.querySelector('form').reset();
            }
        }
        window.submitNewTask = async function(e) {
            e.preventDefault();
            const id = Date.now().toString();
            const status = 'todo';
            tasks[id] = { id, title: document.getElementById('addTitle').value, desc: document.getElementById('addDesc').value, category: document.getElementById('addCategory').value, priority: document.getElementById('addPriority').value, status, order: Object.values(tasks).filter(t => t.status === status).length };
            await saveTasks();
            renderBoard();
            closeModal('addModal');
            e.target.reset();
        }
        window.saveTask = async function(e) {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            if (!tasks[id]) return;
            tasks[id].title = document.getElementById('editTitle').value;
            tasks[id].desc = document.getElementById('editDesc').value;
            tasks[id].status = document.getElementById('editStatus').value;
            tasks[id].category = document.getElementById('editCategory').value;
            tasks[id].priority = document.getElementById('editPriority').value;
            await saveTasks();
            renderBoard();
            closeModal('editModal');
        }
        window.deleteTask = async function() {
            const id = document.getElementById('editId').value;
            if (id && confirm('Delete?')) { delete tasks[id]; await saveTasks(); renderBoard(); closeModal('editModal'); }
        }
        window.openTool = function(tool) {
            const urls = { docs: 'https://docs.google.com', sheets: 'https://sheets.google.com', drive: 'https://drive.google.com', calendar: 'https://calendar.google.com', gmail: 'https://mail.google.com', photos: 'https://photos.google.com' };
            window.open(urls[tool], '_blank');
        }
        document.querySelectorAll('.modal').forEach(m => m.onclick = e => { if (e.target === m) closeModal(m.id); });
        window.loadTasks();
        loadNotes();
        switchTab('tasks');
    </script>
</body>
</html>